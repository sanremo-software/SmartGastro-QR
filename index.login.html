// Add this to the BEGINNING of your main system file
(function() {
    // Check if user is logged in
    const currentUser = JSON.parse(localStorage.getItem('sanremo_current_user') || 'null');
    
    if (!currentUser) {
        // Redirect to login
        window.location.href = '';login.html
        return;
    }
    
    // Verify license is still valid
    const db = JSON.parse(localStorage.getItem('sanremo_database') || '{"licenses":[]}');
    const userLicense = db.licenses.find(l => l.key === currentUser.license);
    
    if (!userLicense || userLicense.status !== 'active') {
        alert('Ihre Lizenz ist nicht mehr aktiv.');
        localStorage.removeItem('sanremo_current_user');
        window.location.href = 'login.html?error=license_inactive';
        return;
    }
    
    // Update last login time
    currentUser.lastLogin = new Date().toISOString();
    localStorage.setItem('sanremo_current_user', JSON.stringify(currentUser));
    
    // Add logout button to your system
    function addLogoutButton() {
        const logoutBtn = document.createElement('button');
        logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
        logoutBtn.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        `;
        logoutBtn.onclick = function() {
            localStorage.removeItem('sanremo_current_user');
            window.location.href = 'login.html';
        };
        document.body.appendChild(logoutBtn);
    }
    
    // Add user info display
    function addUserInfo() {
        const userInfo = document.createElement('div');
        userInfo.style.cssText = `
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            border: 1px solid #ddd;
        `;
        userInfo.innerHTML = `
            <strong>${currentUser.username}</strong><br>
            <small>${currentUser.license}</small>
        `;
        document.body.appendChild(userInfo);
    }
    
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        addLogoutButton();
        addUserInfo();
    });
    
    // Export current user for use in your system
    window.currentSanremoUser = currentUser;
})();
